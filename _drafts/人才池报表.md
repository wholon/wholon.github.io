```sql
-- 区域人才池目标明细表
SELECT
    goal.region_name           AS 区域名称,
    goal.region_code           AS 区域编码,
    goal.dept_type_code        AS 部门编码,
    goal.dept_type_name        AS 部门名称,
    SUM(goal.post_num)         AS 编制人数,
    SUM(goal.on_job_num)       AS 在岗人数,
    SUM(goal.gap_num)          AS 数量缺口,
    SUM(goal.quality_gap_num)  AS 质量缺口,
    SUM(goal.red_line_reserve) AS 红线目标,
    SUM(goal.standard_reserve) AS 达标目标,
    SUM(goal.super_reserve)    AS 超级目标
FROM
    (SELECT
         post.parent_dept,
         post.pool_type_name,
         post.dept_type_name,
         post.dept_type_code,
         post.post_num,
         post.on_job_num,
         post.quality_gap_num,
         post.standard_reserve_ratio,
         post.super_reserve_ratio,
         post.post_num - post.on_job_num                                                           AS gap_num,
         (post.post_num - post.on_job_num) + quality_gap_num                                       AS red_line_reserve,
         post.post_num * standard_reserve_ratio + (post.post_num - post.on_job_num) + quality_gap_num AS standard_reserve,
         post.post_num * super_reserve_ratio + (post.post_num - post.on_job_num) + quality_gap_num    AS super_reserve,

         post.region_code,
         post.region_name
     FROM
         (SELECT
              t13.parent_dept,
              t13.pool_type_name,
              t1.FNum                        AS post_num,
              (SELECT
                   COUNT(1)
               FROM
                   MY_HR_UserInfo AS tt1
                       LEFT JOIN MY_HR_UserType AS tt2 ON tt1.Type = tt2.Code
               WHERE
                     tt1.EntryState = '1'
                 AND tt2.FJob = '1'
                 AND tt1.Job = t1.FPostCode) AS on_job_num,
              (SELECT
                   COUNT(1)
               FROM
                   MY_HR_UserInfo AS tt1
                       LEFT JOIN MY_HR_UserType AS tt2 ON tt1.Type = tt2.Code
                       LEFT JOIN MY_HR_Rank AS tt3 ON tt3.ID = tt1.Rank
                       LEFT JOIN MY_HR_Grade AS tt4 ON tt4.ID = tt3.GradeID
               WHERE
                     tt1.EntryState = '1'
                 AND tt2.FJob = '1'
                 AND tt1.Job = t1.FPostCode
                 AND tt4.FInt < t8.FInt)     AS quality_gap_num,
              t5.FReserveRatio               AS standard_reserve_ratio,
              t5.FSuperReserveRatio          AS super_reserve_ratio,
              t14.Name                       AS dept_type_name,
              t14.Code                       AS dept_type_code,
              t15.BillNo                     AS region_code,
              t15.name                       AS region_name

          FROM
              MY_HR_PostInfoNew AS t1
                  LEFT JOIN MY_HR_DeptInfo AS t2 ON t1.FDept = t2.FDeptCode
                  LEFT JOIN MY_HR_CompanyInfo AS t3 ON t3.FCompCode = t2.FCompany
                  LEFT JOIN MY_HR_PostSeries AS t4 ON t4.Code = t1.FPostseries
                  LEFT JOIN MY_HR_Talent_Post AS t5 ON t5.FBillNO = t1.FStaCode
                  LEFT JOIN MY_HR_UserTag AS t6 ON t6.ID = t5.FTechnologyType
                  LEFT JOIN MY_HR_UserTag AS t7 ON t7.ID = t5.FStarRating
                  LEFT JOIN MY_HR_Grade AS t8 ON t5.FGrade_ID = t8.ID
                  LEFT JOIN MY_HR_Rank AS t9 ON t9.ID = t5.FStart_Rank_ID
                  LEFT JOIN MY_HR_Rank AS t10 ON t10.ID = t5.FEnd_Rank_ID
                  LEFT JOIN MY_HR_Grade AS t11 ON t11.ID = t9.GradeID
                  LEFT JOIN MY_HR_Grade AS t12 ON t12.ID = t10.GradeID
                  LEFT JOIN MY_HR_Talent_Pool_Type AS t13 ON t13.id = t5.TalentPoolTypeCode
                  LEFT JOIN MY_HR_DeptInfoType AS t14 ON t14.Code = t5.FDeptType_Code
                  LEFT JOIN MY_HR_MainRegion AS t15 ON t15.BillNo = t3.MainRegion
          WHERE
              t1.FState = '1') post) goal
GROUP BY
    goal.region_name, goal.region_code, dept_type_code, dept_type_name
order BY goal.region_code, goal.dept_type_code





```

